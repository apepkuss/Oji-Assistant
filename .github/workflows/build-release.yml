name: Build and Release Electron App

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

jobs:
  build-web:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Clean npm cache and install dependencies
        run: |
          npm cache clean --force
          rm -rf node_modules package-lock.json
          npm install --legacy-peer-deps
          npm install @rollup/rollup-linux-x64-gnu --save-optional

      - name: Build Web app
        run: npm run build
        env:
          VITE_APP_VERSION: ${{ github.ref_name }}
          NODE_OPTIONS: --max-old-space-size=4096

      - name: Upload web build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: dist/
          retention-days: 7

      - name: Deploy to GitHub Pages
        if: startsWith(github.ref, 'refs/tags/v')
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist

  build:
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        include:
          - os: macos-latest
            platform: mac
          - os: ubuntu-latest
            platform: linux
          - os: windows-latest
            platform: win

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Clean npm cache and install dependencies (Linux)
        if: matrix.os == 'ubuntu-latest'
        shell: bash
        run: |
          npm cache clean --force
          rm -rf node_modules package-lock.json
          npm install --legacy-peer-deps
          npm install @rollup/rollup-linux-x64-gnu --save-optional

      - name: Clean npm cache and install dependencies (Windows)
        if: matrix.os == 'windows-latest'
        shell: cmd
        run: |
          npm cache clean --force
          if exist node_modules rmdir /s /q node_modules
          if exist package-lock.json del package-lock.json
          npm install --legacy-peer-deps
          npm rebuild

      - name: Verify Vite installation (Windows)
        if: matrix.os == 'windows-latest'
        shell: cmd
        run: |
          npx vite --version
          dir node_modules\.bin\vite*

      - name: Clean npm cache and install dependencies (macOS)
        if: matrix.os == 'macos-latest'
        shell: bash
        run: |
          npm cache clean --force
          rm -rf node_modules package-lock.json
          npm install --legacy-peer-deps

      - name: Verify installations
        run: |
          npm list vite
          npm list @vitejs/plugin-react
        continue-on-error: true

      - name: Build React app
        run: npm run build
        env:
          NODE_OPTIONS: --max-old-space-size=4096

      - name: Build Electron app
        run: npm run build:${{ matrix.platform }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}-build
          path: release/
          retention-days: 7

  release:
    needs: [build-web, build]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Display downloaded files
        run: find artifacts/ -type f -exec ls -la {} \;

      - name: Create web app archive
        run: |
          cd artifacts/web-build
          zip -r ../../oji-web-${{ github.ref_name }}.zip .
          cd ../..

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/**/*
            oji-web-${{ github.ref_name }}.zip
          body: |
            ## üöÄ Oji ${{ github.ref_name }}

            Cross-platform desktop application and web app release

            ### üì• Downloads

            #### üñ•Ô∏è Desktop Versions
            - **macOS**: Download `.dmg` file (supports Intel and Apple Silicon)
            - **Windows**: Download `.exe` installer
            - **Linux**: Download `.AppImage`, `.deb`, or `.rpm` package

            #### üåê Web Version
            - **Online Access**: [https://${{ github.repository_owner }}.github.io/Oji-Assistant](https://${{ github.repository_owner }}.github.io/Oji-Assistant)
            - **Offline Deployment**: Download `oji-web-${{ github.ref_name }}.zip` file

            ### üõ†Ô∏è Installation Instructions

            #### üñ•Ô∏è Desktop Versions

            **macOS**
            1. Download the `.dmg` file
            2. Open the downloaded file
            3. Drag the app to Applications folder

            **Windows**
            1. Download the `.exe` installer
            2. Run the installer and follow the setup wizard

            **Linux**
            - **AppImage**: Download and add execute permission with `chmod +x`, then run directly
            - **DEB** (Ubuntu/Debian): Install using `sudo dpkg -i filename.deb`
            - **RPM** (Fedora/RHEL): Install using `sudo rpm -i filename.rpm`

            #### üåê Web Version

            **Online Usage**
            - Simply visit the link above to use Oji in your browser

            **Local Deployment**
            1. Download the `oji-web-${{ github.ref_name }}.zip` file
            2. Extract to your web server directory
            3. Access through web server (nginx, apache, or simple `python -m http.server`)

            **Docker Deployment**
            ```bash
            # Extract web files
            unzip oji-web-${{ github.ref_name }}.zip -d oji-web

            # Deploy using nginx container
            docker run -d -p 8080:80 -v $(pwd)/oji-web:/usr/share/nginx/html nginx

            # Access at http://localhost:8080
            ```

            ### ‚öôÔ∏è Configuration Notes
            - Web and desktop versions have identical functionality
            - Requires proper AI service endpoint URL configuration
            - Web version supports all modern browsers
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
