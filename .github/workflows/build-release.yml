name: Build and Release Electron App

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write
  discussions: write

jobs:
  build-web:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Clean npm cache and install dependencies
        run: |
          npm cache clean --force
          rm -rf node_modules package-lock.json
          npm install --legacy-peer-deps

      - name: Update package version
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          npm version $VERSION --no-git-tag-version
          echo "Updated version to $VERSION"

      - name: Build Web app
        run: npm run build
        env:
          VITE_APP_VERSION: ${{ github.ref_name }}
          NODE_OPTIONS: --max-old-space-size=4096
          ROLLUP_WATCH: false

      - name: Upload web build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: dist/
          retention-days: 7

  deploy-pages:
    needs: build-web
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: read
      pages: write
      id-token: write

    steps:
      - name: Download web build artifacts
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: ./dist

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
        id: deployment

  build:
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        include:
          - os: macos-latest
            platform: mac
          - os: ubuntu-latest
            platform: linux
          - os: windows-latest
            platform: win

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Clean npm cache and install dependencies (Linux)
        if: matrix.os == 'ubuntu-latest'
        shell: bash
        run: |
          npm cache clean --force
          rm -rf node_modules package-lock.json
          npm install --legacy-peer-deps

      - name: Update package version (Linux)
        if: matrix.os == 'ubuntu-latest' && startsWith(github.ref, 'refs/tags/v')
        shell: bash
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          npm version $VERSION --no-git-tag-version
          echo "Updated version to $VERSION"

      - name: Clean npm cache and install dependencies (Windows)
        if: matrix.os == 'windows-latest'
        shell: powershell
        run: |
          npm cache clean --force
          if (Test-Path node_modules) { Remove-Item -Recurse -Force node_modules }
          if (Test-Path package-lock.json) { Remove-Item package-lock.json }
          npm install --legacy-peer-deps
          npm install vite@^7.0.4 --save-dev
          npm rebuild

      - name: Update package version (Windows)
        if: matrix.os == 'windows-latest' && startsWith(github.ref, 'refs/tags/v')
        shell: powershell
        run: |
          $version = $env:GITHUB_REF -replace 'refs/tags/v', ''
          npm version $version --no-git-tag-version
          Write-Host "Updated version to $version"

      - name: Verify Vite installation (Windows)
        if: matrix.os == 'windows-latest'
        shell: powershell
        run: |
          Write-Host "Checking npm list..."
          npm list vite
          Write-Host "Checking node_modules\.bin..."
          Get-ChildItem node_modules\.bin\vite*
          Write-Host "Checking PATH..."
          $env:PATH
          Write-Host "Checking if vite.cmd exists..."
          if (Test-Path node_modules\.bin\vite.cmd) { Write-Host "vite.cmd found" } else { Write-Host "vite.cmd NOT found" }
          Write-Host "Trying npx vite version..."
          npx vite --version

      - name: Add node_modules to PATH (Windows)
        if: matrix.os == 'windows-latest'
        shell: powershell
        run: |
          $currentPath = $env:PATH
          $nodeModulesBin = "$(pwd)\node_modules\.bin"
          $env:PATH = "$nodeModulesBin;$currentPath"
          Write-Host "Updated PATH: $env:PATH"

      - name: Clean npm cache and install dependencies (macOS)
        if: matrix.os == 'macos-latest'
        shell: bash
        run: |
          npm cache clean --force
          rm -rf node_modules package-lock.json
          npm install --legacy-peer-deps

      - name: Update package version (macOS)
        if: matrix.os == 'macos-latest' && startsWith(github.ref, 'refs/tags/v')
        shell: bash
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          npm version $VERSION --no-git-tag-version
          echo "Updated version to $VERSION"

      - name: Verify installations
        run: |
          npm list vite
          npm list @vitejs/plugin-react
        continue-on-error: true

      - name: Build React app (Windows)
        if: matrix.os == 'windows-latest'
        shell: powershell
        run: npm run build:react
        env:
          NODE_OPTIONS: --max-old-space-size=4096

      - name: Build React app (Non-Windows)
        if: matrix.os != 'windows-latest'
        run: npm run build
        env:
          NODE_OPTIONS: --max-old-space-size=4096

      - name: Build Electron app
        run: npm run build:${{ matrix.platform }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}-build
          path: release/
          retention-days: 7

  release:
    needs: [build-web, build, deploy-pages]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
      discussions: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Display downloaded files
        run: find artifacts/ -type f -exec ls -la {} \;

      - name: Extract and filter release files
        run: |
          # ================================================================
          # RELEASE FILES FILTERING EXPLANATION:
          # ================================================================
          # ESSENTIAL FILES (always include):
          # - *.dmg: macOS disk image installers
          # - *Setup*.exe: Windows installer executables
          # - *.AppImage: Linux portable applications
          # - *.deb: Debian/Ubuntu packages
          # - *.rpm: Red Hat/Fedora packages
          # - oji-web-*.zip: Web application bundle
          #
          # EXCLUDED FILES (not needed for current build types):
          # - elevate.exe: Windows UAC elevation tool (not needed by users)
          # - *.pak: Chromium resource files (bundled in app)
          # - *.dll/*.so/*.dylib: System libraries (bundled in app)
          # - Individual zip files that duplicate dmg functionality
          #
          # INCLUDED AUTO-UPDATE FILES:
          # - latest.yml: Windows auto-updater (for NSIS installer versions)
          # - latest-mac.yml: macOS auto-updater (dmg versions support updates)
          # - latest-linux.yml: Linux auto-updater (deb/rpm/AppImage can support updates)
          # ================================================================

          # Create directory for final release files
          mkdir -p release-files/

          # Preserve web-build directory
          if [ -d "artifacts/web-build" ]; then
            cp -r artifacts/web-build ./web-build-backup
            echo "Backed up web-build directory"
          fi

          # Find and copy main distribution files using a simpler approach
          echo "Finding and copying release files..."

          # === ESSENTIAL FILES FOR END USERS ===

          # Copy .dmg files (macOS installers)
          find artifacts/ -name "*.dmg" | while read file; do
            filename=$(basename "$file")
            if [ ! -f "release-files/$filename" ]; then
              cp "$file" "release-files/"
              echo "Copied: $filename (macOS installer)"
            fi
          done          # Copy .exe files (Windows) - NSIS installer only
          find artifacts/ -name "*Setup*.exe" -o -name "*setup*.exe" | while read file; do
            filename=$(basename "$file")
            if [ ! -f "release-files/$filename" ]; then
              cp "$file" "release-files/"
              echo "Copied: $filename (Windows installer)"
            fi
          done

          # Copy .AppImage files (Linux portable applications)
          find artifacts/ -name "*.AppImage" | while read file; do
            filename=$(basename "$file")
            if [ ! -f "release-files/$filename" ]; then
              cp "$file" "release-files/"
              echo "Copied: $filename (Linux portable app)"
            fi
          done

          # Copy .deb files (Debian/Ubuntu packages)
          find artifacts/ -name "*.deb" | while read file; do
            filename=$(basename "$file")
            if [ ! -f "release-files/$filename" ]; then
              cp "$file" "release-files/"
              echo "Copied: $filename (Debian/Ubuntu package)"
            fi
          done

          # Copy .rpm files (Red Hat/Fedora packages)
          find artifacts/ -name "*.rpm" | while read file; do
            filename=$(basename "$file")
            if [ ! -f "release-files/$filename" ]; then
              cp "$file" "release-files/"
              echo "Copied: $filename (Red Hat/Fedora package)"
            fi
          done          # Copy .zip files from release directory (platform packages) - exclude duplicates
          find artifacts/ -name "*.zip" -path "*/release/*" | while read file; do
            filename=$(basename "$file")
            # Skip if it's a duplicate of dmg (prefer dmg over zip for mac)
            if [[ "$filename" =~ mac\.zip$ ]] && find release-files/ -name "*.dmg" | grep -q .; then
              echo "Skipping $filename (dmg version preferred)"
              continue
            fi
            if [ ! -f "release-files/$filename" ]; then
              cp "$file" "release-files/"
              echo "Copied: $filename"
            fi
          done

          # Copy latest*.yml files (auto-updater configs) - all platforms support auto-update
          # latest.yml (Windows NSIS installer) - ENABLED
          # latest-mac.yml (macOS dmg) - ENABLED
          # latest-linux.yml (Linux deb/rpm/AppImage) - ENABLED
          find artifacts/ -name "latest*.yml" | while read file; do
            filename=$(basename "$file")
            if [ ! -f "release-files/$filename" ]; then
              cp "$file" "release-files/"
              platform=$(echo $filename | sed 's/latest-//;s/latest//;s/.yml//' | sed 's/^$/windows/')
              echo "Copied: $filename (auto-updater config for $platform)"
            fi
          done

          # List final files for upload
          echo "Final release files:"
          ls -la release-files/

      - name: Delete existing release if exists
        continue-on-error: true
        run: |
          gh release delete ${{ github.ref_name }} --yes || true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create web app archive
        run: |
          if [ -d "web-build-backup" ]; then
            echo "Found web-build backup directory"
            cd web-build-backup
            zip -r ../oji-web-${{ github.ref_name }}.zip .
            cd ..
            echo "Created web archive: oji-web-${{ github.ref_name }}.zip"
            ls -la oji-web-${{ github.ref_name }}.zip
          else
            echo "Error: web-build backup directory not found"
            echo "Available directories:"
            ls -la
            exit 1
          fi

      - name: List exact files to upload
        run: |
          echo "=== Files to be uploaded ==="
          echo "Release files:"
          ls -la release-files/
          echo "Web archive:"
          ls -la oji-web-${{ github.ref_name }}.zip 2>/dev/null || true

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release-files/*
            oji-web-${{ github.ref_name }}.zip
          body: |
            ## 🚀 Oji ${{ github.ref_name }}

            Cross-platform desktop application and web app release

            > **⚠️ macOS Users**: If you see "Oji is damaged" error, right-click the app and select "Open" to bypass Gatekeeper security. This app is not Apple-notarized but is safe to use.

            ### 📥 Downloads

            #### 🖥️ Desktop Versions
            - **macOS**: Download `.dmg` file (supports Intel and Apple Silicon)
            - **Windows**: Download `.exe` installer (supports auto-update)
            - **Linux**: Download `.AppImage`, `.deb`, or `.rpm` package

            #### 🌐 Web Version
            - **Online Access**: [https://${{ github.repository_owner }}.github.io/Oji-Assistant](https://${{ github.repository_owner }}.github.io/Oji-Assistant)
            - **Offline Deployment**: Download `oji-web-${{ github.ref_name }}.zip` file

            ### 🛠️ Installation Instructions

            #### 🖥️ Desktop Versions

            **macOS**
            1. Download the `.dmg` file
            2. Open the downloaded file
            3. Drag the app to Applications folder
            4. **If you see "Oji is damaged" error**: Right-click the app → "Open" → "Open" to bypass Gatekeeper

            > **Note**: This app is not notarized by Apple. For first launch, you may need to:
            > - Right-click the app and select "Open" instead of double-clicking
            > - Or go to System Preferences → Security & Privacy → General → Allow apps downloaded from "App Store and identified developers"

            **Windows**
            1. Download the `.exe` installer
            2. Run the installer and follow the setup wizard
            3. App will be installed and supports automatic updates

            **Linux**
            - **AppImage**: Download and add execute permission with `chmod +x`, then run directly
            - **DEB** (Ubuntu/Debian): Install using `sudo dpkg -i filename.deb`
            - **RPM** (Fedora/RHEL): Install using `sudo rpm -i filename.rpm`

            #### 🌐 Web Version

            **Online Usage**
            - Simply visit the link above to use Oji in your browser

            **Local Deployment**
            1. Download the `oji-web-${{ github.ref_name }}.zip` file
            2. Extract to your web server directory
            3. Access through web server (nginx, apache, or simple `python -m http.server`)

            **Docker Deployment**
            ```bash
            # Extract web files
            unzip oji-web-${{ github.ref_name }}.zip -d oji-web

            # Deploy using nginx container
            docker run -d -p 8080:80 -v $(pwd)/oji-web:/usr/share/nginx/html nginx

            # Access at http://localhost:8080
            ```

            ### ⚙️ Configuration Notes
            - Web and desktop versions have identical functionality
            - Requires proper AI service endpoint URL configuration
            - Web version supports all modern browsers
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Fallback Release Creation (if main fails)
        if: failure() && steps.create_release.outcome == 'failure'
        run: |
          echo "Main release creation failed, trying GitHub CLI..."
          gh release create ${{ github.ref_name }} \
            release-files/* \
            oji-web-${{ github.ref_name }}.zip \
            --title "Oji ${{ github.ref_name }}" \
            --notes "Cross-platform desktop application and web app release" || true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
