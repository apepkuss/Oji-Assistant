<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oji CORS æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .pending {
            background-color: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }
        input, button {
            padding: 8px 12px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        .input-group {
            margin: 10px 0;
        }
        label {
            display: inline-block;
            width: 120px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” Oji AI æœåŠ¡ CORS æµ‹è¯•</h1>
        <p>æ­¤é¡µé¢ç”¨äºæµ‹è¯• Axum AI æœåŠ¡çš„è·¨åŸŸè®¿é—®é…ç½®</p>

        <!-- é…ç½®åŒºåŸŸ -->
        <div class="test-section">
            <h3>âš™ï¸ æœåŠ¡é…ç½®</h3>
            <div class="input-group">
                <label>Base URL:</label>
                <input type="text" id="baseUrl" value="http://localhost:9068/v1" style="width: 300px;">
            </div>
            <div class="input-group">
                <label>API Key:</label>
                <input type="text" id="apiKey" placeholder="(å¯é€‰)" style="width: 300px;">
            </div>
        </div>

        <!-- CORS é¢„æ£€æµ‹è¯• -->
        <div class="test-section pending" id="preflightTest">
            <h3>1ï¸âƒ£ CORS é¢„æ£€æµ‹è¯• (OPTIONS è¯·æ±‚)</h3>
            <p>æµ‹è¯•æµè§ˆå™¨æ˜¯å¦èƒ½å‘é€ OPTIONS é¢„æ£€è¯·æ±‚</p>
            <button onclick="testPreflight()">å¼€å§‹é¢„æ£€æµ‹è¯•</button>
            <div id="preflightResult"></div>
        </div>

        <!-- ç®€å•è¯·æ±‚æµ‹è¯• -->
        <div class="test-section pending" id="simpleTest">
            <h3>2ï¸âƒ£ ç®€å• GET è¯·æ±‚æµ‹è¯•</h3>
            <p>æµ‹è¯•æ˜¯å¦èƒ½å‘é€ç®€å•çš„è·¨åŸŸ GET è¯·æ±‚</p>
            <button onclick="testSimpleRequest()">æµ‹è¯• GET è¯·æ±‚</button>
            <div id="simpleResult"></div>
        </div>

        <!-- AI èŠå¤©æµ‹è¯• -->
        <div class="test-section pending" id="chatTest">
            <h3>3ï¸âƒ£ AI èŠå¤©åŠŸèƒ½æµ‹è¯•</h3>
            <p>æµ‹è¯•å®Œæ•´çš„ AI èŠå¤© API è°ƒç”¨</p>
            <div class="input-group">
                <label>æµ‹è¯•æ¶ˆæ¯:</label>
                <input type="text" id="testMessage" value="Hello, how are you?" style="width: 300px;">
            </div>
            <button onclick="testChatAPI()">æµ‹è¯•èŠå¤© API</button>
            <div id="chatResult"></div>
        </div>

        <!-- æµå¼å“åº”æµ‹è¯• -->
        <div class="test-section pending" id="streamTest">
            <h3>4ï¸âƒ£ æµå¼å“åº”æµ‹è¯•</h3>
            <p>æµ‹è¯•æµå¼èŠå¤©å“åº”æ˜¯å¦æ”¯æŒè·¨åŸŸ</p>
            <button onclick="testStreamAPI()">æµ‹è¯•æµå¼å“åº”</button>
            <div id="streamResult"></div>
        </div>

        <!-- æ€»ç»“ -->
        <div class="test-section" id="summary">
            <h3>ğŸ“Š æµ‹è¯•æ€»ç»“</h3>
            <div id="summaryContent">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•...</div>
        </div>
    </div>

    <script>
        let testResults = {
            preflight: null,
            simple: null,
            chat: null,
            stream: null
        };

        function getBaseUrl() {
            return document.getElementById('baseUrl').value.trim();
        }

        function getApiKey() {
            return document.getElementById('apiKey').value.trim();
        }

        function updateTestSection(sectionId, status, content) {
            const section = document.getElementById(sectionId);
            section.className = `test-section ${status}`;
            const resultDiv = section.querySelector('div[id$="Result"]');
            if (resultDiv) {
                resultDiv.innerHTML = content;
            }
        }

        function updateSummary() {
            const total = Object.keys(testResults).length;
            const passed = Object.values(testResults).filter(r => r === true).length;
            const failed = Object.values(testResults).filter(r => r === false).length;
            const pending = total - passed - failed;

            let summaryHtml = `
                <p><strong>æµ‹è¯•è¿›åº¦:</strong> ${passed + failed}/${total} å®Œæˆ</p>
                <p>âœ… é€šè¿‡: ${passed} | âŒ å¤±è´¥: ${failed} | â³ å¾…æµ‹è¯•: ${pending}</p>
            `;

            if (pending === 0) {
                if (failed === 0) {
                    summaryHtml += `
                        <div style="background: #d4edda; padding: 10px; border-radius: 4px; margin-top: 10px;">
                            <strong>ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼</strong><br>
                            æ‚¨çš„ Axum AI æœåŠ¡å®Œå…¨æ”¯æŒ Web ç‰ˆæœ¬çš„è·¨åŸŸè®¿é—®ã€‚
                        </div>
                    `;
                } else {
                    summaryHtml += `
                        <div style="background: #f8d7da; padding: 10px; border-radius: 4px; margin-top: 10px;">
                            <strong>âš ï¸ éƒ¨åˆ†æµ‹è¯•å¤±è´¥</strong><br>
                            è¯·æ£€æŸ¥ AI æœåŠ¡é…ç½®å’Œç½‘ç»œè¿æ¥ã€‚
                        </div>
                    `;
                }
            }

            document.getElementById('summaryContent').innerHTML = summaryHtml;
        }

        async function testPreflight() {
            updateTestSection('preflightTest', 'pending', 'æ­£åœ¨æµ‹è¯• CORS é¢„æ£€...');

            try {
                // å‘é€ä¸€ä¸ªä¼šè§¦å‘é¢„æ£€çš„è¯·æ±‚
                const response = await fetch(`${getBaseUrl()}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': getApiKey() ? `Bearer ${getApiKey()}` : 'Bearer test'
                    },
                    body: JSON.stringify({
                        model: "test",
                        messages: [{"role": "user", "content": "test"}]
                    })
                });

                testResults.preflight = true;
                updateTestSection('preflightTest', 'success', `
                    <p>âœ… CORS é¢„æ£€æˆåŠŸï¼</p>
                    <p>çŠ¶æ€ç : ${response.status}</p>
                    <p>æœåŠ¡å™¨æ­£ç¡®å“åº”äº† OPTIONS é¢„æ£€è¯·æ±‚</p>
                `);
            } catch (error) {
                testResults.preflight = false;
                updateTestSection('preflightTest', 'error', `
                    <p>âŒ CORS é¢„æ£€å¤±è´¥</p>
                    <p>é”™è¯¯: ${error.message}</p>
                    <p>è¿™é€šå¸¸è¡¨ç¤ºæœåŠ¡å™¨æœªæ­£ç¡®é…ç½® CORS</p>
                `);
            }
            updateSummary();
        }

        async function testSimpleRequest() {
            updateTestSection('simpleTest', 'pending', 'æ­£åœ¨æµ‹è¯•ç®€å• GET è¯·æ±‚...');

            try {
                // æµ‹è¯•ä¸€ä¸ªç®€å•çš„ GET è¯·æ±‚ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
                const response = await fetch(`${getBaseUrl().replace('/v1', '')}/health`, {
                    method: 'GET'
                });

                if (response.ok) {
                    testResults.simple = true;
                    updateTestSection('simpleTest', 'success', `
                        <p>âœ… ç®€å•è¯·æ±‚æˆåŠŸï¼</p>
                        <p>çŠ¶æ€ç : ${response.status}</p>
                    `);
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                // å¦‚æœæ²¡æœ‰ health ç«¯ç‚¹ï¼Œå°è¯• OPTIONS è¯·æ±‚
                try {
                    const response = await fetch(getBaseUrl(), {
                        method: 'OPTIONS'
                    });
                    testResults.simple = true;
                    updateTestSection('simpleTest', 'success', `
                        <p>âœ… OPTIONS è¯·æ±‚æˆåŠŸï¼</p>
                        <p>çŠ¶æ€ç : ${response.status}</p>
                    `);
                } catch (optionsError) {
                    testResults.simple = false;
                    updateTestSection('simpleTest', 'error', `
                        <p>âŒ ç®€å•è¯·æ±‚å¤±è´¥</p>
                        <p>GET é”™è¯¯: ${error.message}</p>
                        <p>OPTIONS é”™è¯¯: ${optionsError.message}</p>
                    `);
                }
            }
            updateSummary();
        }

        async function testChatAPI() {
            updateTestSection('chatTest', 'pending', 'æ­£åœ¨æµ‹è¯• AI èŠå¤© API...');

            try {
                const headers = {
                    'Content-Type': 'application/json'
                };

                if (getApiKey()) {
                    headers['Authorization'] = `Bearer ${getApiKey()}`;
                }

                const response = await fetch(`${getBaseUrl()}/chat/completions`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({
                        model: "Unknown",
                        messages: [
                            {
                                role: "user",
                                content: document.getElementById('testMessage').value
                            }
                        ],
                        stream: false
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    testResults.chat = true;
                    updateTestSection('chatTest', 'success', `
                        <p>âœ… AI èŠå¤© API è°ƒç”¨æˆåŠŸï¼</p>
                        <p>çŠ¶æ€ç : ${response.status}</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `);
                } else {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
            } catch (error) {
                testResults.chat = false;
                updateTestSection('chatTest', 'error', `
                    <p>âŒ AI èŠå¤© API è°ƒç”¨å¤±è´¥</p>
                    <p>é”™è¯¯: ${error.message}</p>
                    <p>è¯·æ£€æŸ¥æœåŠ¡æ˜¯å¦æ­£åœ¨è¿è¡Œï¼Œä»¥åŠ API é…ç½®æ˜¯å¦æ­£ç¡®</p>
                `);
            }
            updateSummary();
        }

        async function testStreamAPI() {
            updateTestSection('streamTest', 'pending', 'æ­£åœ¨æµ‹è¯•æµå¼å“åº”...');

            try {
                const headers = {
                    'Content-Type': 'application/json'
                };

                if (getApiKey()) {
                    headers['Authorization'] = `Bearer ${getApiKey()}`;
                }

                const response = await fetch(`${getBaseUrl()}/chat/completions`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({
                        model: "Unknown",
                        messages: [
                            {
                                role: "user",
                                content: "è¯·ç®€çŸ­å›å¤ï¼šä½ å¥½"
                            }
                        ],
                        stream: true
                    })
                });

                if (response.ok && response.body) {
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let streamContent = '';
                    let chunks = 0;

                    try {
                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;

                            chunks++;
                            const chunk = decoder.decode(value);
                            streamContent += chunk;

                            if (chunks >= 3) break; // è¯»å–å‡ ä¸ªå—å°±å¤Ÿäº†
                        }

                        testResults.stream = true;
                        updateTestSection('streamTest', 'success', `
                            <p>âœ… æµå¼å“åº”æµ‹è¯•æˆåŠŸï¼</p>
                            <p>çŠ¶æ€ç : ${response.status}</p>
                            <p>æ¥æ”¶åˆ° ${chunks} ä¸ªæ•°æ®å—</p>
                            <pre>${streamContent.substring(0, 500)}${streamContent.length > 500 ? '...' : ''}</pre>
                        `);
                    } finally {
                        reader.releaseLock();
                    }
                } else {
                    throw new Error(`HTTP ${response.status} æˆ–æ— å“åº”ä½“`);
                }
            } catch (error) {
                testResults.stream = false;
                updateTestSection('streamTest', 'error', `
                    <p>âŒ æµå¼å“åº”æµ‹è¯•å¤±è´¥</p>
                    <p>é”™è¯¯: ${error.message}</p>
                    <p>æµå¼å“åº”å¯èƒ½éœ€è¦ç‰¹æ®Šçš„ CORS é…ç½®</p>
                `);
            }
            updateSummary();
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            updateSummary();
        };
    </script>
</body>
</html>
